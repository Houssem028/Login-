<!doctype html>
<html lang="fr" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ASH Admin App</title>

<!-- App Icon & PWA -->
<link rel="icon" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-512.png">
<link rel="manifest" href="manifest-admin.json">
<meta name="theme-color" content="#0a3cff">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family:'Poppins',sans-serif; margin:0; padding:0; background:#f5f7fa; color:#333; }
header { background: linear-gradient(90deg,#0a3cff,#00c6ff); color:#fff; text-align:center; padding:20px; font-size:22px; font-weight:700; }
.container { max-width:1200px; margin:20px auto; padding:15px; }
h2 { color:#0a3cff; margin-top:30px; text-align:center; }
table { width:100%; border-collapse:collapse; margin-top:15px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.1); }
th,td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#0a3cff; color:#fff; }
input, select { width:90%; padding:6px; border-radius:6px; border:1px solid #ccc; }
button { background:#0a3cff; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
button:hover { background:#084dcc; }
.stats { display:flex; justify-content:space-around; flex-wrap:wrap; margin-top:30px; }
.stat-box { background:#fff; padding:20px; border-radius:12px; width:200px; margin:10px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
.stat-box h3 { margin:10px 0; color:#0a3cff; }
.notification { position:fixed; top:20px; right:20px; background:#0a3cff; color:#fff; padding:14px 20px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.35); display:none; z-index:1000; }
#pagination-bookings { text-align:center; margin-top:15px; }
#pagination-bookings button { margin:0 3px; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:#0a3cff; color:#fff; }
#pagination-bookings button.active { background:#084dcc; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<header>ASH Window Cleaning - Admin</header>

<div class="container">
  <h2>üìÖ R√©servations</h2>
  <table>
    <thead>
      <tr>
        <th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>Service</th>
        <th>Adresse</th><th>Date</th><th>Heure</th>
        <th>Montant</th><th>Termin√©</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="bookings"></tbody>
  </table>
  <div id="pagination-bookings"></div>

  <h2>‚≠ê Avis Clients</h2>
  <table>
    <thead>
      <tr>
        <th>Nom</th><th>Email</th><th>Note</th><th>Message</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="ratings"></tbody>
  </table>

  <h2>üìä Statistiques</h2>
  <div class="stats">
    <div class="stat-box" id="total-bookings"><h3>Total R√©servations</h3><p>0</p></div>
    <div class="stat-box" id="total-done"><h3>R√©servations Termin√©es</h3><p>0</p></div>
    <div class="stat-box" id="average-rating"><h3>Note Moyenne</h3><p>0</p></div>
  </div>
</div>

<div class="notification" id="notification"></div>

<script>
// ===== Firebase Init =====
const firebaseConfig = {
  apiKey: "AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
  authDomain: "admin-ash-f622c.firebaseapp.com",
  projectId: "admin-ash-f622c",
  storageBucket: "admin-ash-f622c.appspot.com",
  messagingSenderId: "76505742154",
  appId: "1:76505742154:web:dc4f190f9f2de80acb1fb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Notifications =====
function showNotification(msg) {
  const n = document.getElementById('notification');
  n.textContent = msg;
  n.style.display='block';
  setTimeout(()=>n.style.display='none',4000);
}

// ===== Bookings Pagination =====
function paginateBookings(docs) {
  const perPage = 5;
  let currentPage = 1;
  const totalPages = Math.ceil(docs.length / perPage);
  const tbody = document.getElementById("bookings");

  function showPage(page) {
    tbody.innerHTML = "";
    const start = (page-1)*perPage;
    const end = start+perPage;
    docs.slice(start,end).forEach(doc=>{
      const d = doc.data();
      tbody.innerHTML += `
      <tr>
        <td><input value="${d.name}" onchange="updateBooking('${doc.id}','name',this.value)"></td>
        <td><input value="${d.phone}" onchange="updateBooking('${doc.id}','phone',this.value)"></td>
        <td>${d.email}</td>
        <td>${d.service}</td>
        <td>${d.address}</td>
        <td>${d.date}</td>
        <td>${d.time}</td>
        <td><input type="number" value="${d.amount||0}" onchange="updateBooking('${doc.id}','amount',this.value)"></td>
        <td><input type="checkbox" ${d.done?'checked':''} onchange="updateBooking('${doc.id}','done',this.checked)"></td>
        <td><button onclick="deleteBooking('${doc.id}')">Supprimer</button></td>
      </tr>`;
    });

    // Pagination buttons
    const paginationDiv = document.getElementById("pagination-bookings");
    paginationDiv.innerHTML = "";
    for(let i=1;i<=totalPages;i++){
      const btn = document.createElement("button");
      btn.textContent=i;
      btn.className = i===page ? "active" : "";
      btn.onclick = ()=>showPage(i);
      paginationDiv.appendChild(btn);
    }
  }

  showPage(currentPage);
}

// ===== Load Bookings =====
function loadBookings(){
  db.collection("bookings").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    let docs = snapshot.docs;
    let totalDone = docs.filter(d => d.data().done).length;
    document.getElementById("total-bookings").querySelector("p").textContent = snapshot.size;
    document.getElementById("total-done").querySelector("p").textContent = totalDone;
    if(snapshot.docChanges().some(c=>c.type==='added')) showNotification('Nouvelle r√©servation re√ßue !');

    paginateBookings(docs);
  });
}

// ===== Update/Delete Bookings =====
function updateBooking(id,field,value){
  if(field==="done") value=Boolean(value);
  if(field==="amount") value=Number(value);
  db.collection("bookings").doc(id).update({ [field]: value });
}
function deleteBooking(id){
  if(confirm("Voulez-vous vraiment supprimer cette r√©servation ?")){
    db.collection("bookings").doc(id).delete();
  }
}

// ===== Load Ratings =====
function loadRatings(){
  db.collection("ratings").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    const tbody = document.getElementById("ratings");
    tbody.innerHTML="";
    let totalRating=0;
    snapshot.forEach(doc=>{
      const d = doc.data();
      totalRating+=d.rating||0;
      tbody.innerHTML+=`
      <tr>
        <td>${d.name}</td>
        <td>${d.email}</td>
        <td>${"‚≠ê".repeat(d.rating)}</td>
        <td>${d.message||""}</td>
        <td><button onclick="deleteRating('${doc.id}')">Supprimer</button></td>
      </tr>`;
    });
    document.getElementById("average-rating").querySelector("p").textContent = snapshot.size ? (totalRating/snapshot.size).toFixed(1) : 0;
    if(snapshot.docChanges().some(c=>c.type==='added')) showNotification('Nouveau avis re√ßu !');
  });
}

function deleteRating(id){
  if(confirm("Voulez-vous vraiment supprimer cet avis ?")){
    db.collection("ratings").doc(id).delete();
  }
}

// ===== Init =====
loadBookings();
loadRatings();
</script>

</body>
</html>
