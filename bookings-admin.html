<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin ‚Äì ASH Window Cleaning</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<style>
body{
  font-family:Poppins,Arial,sans-serif;
  background:#f5f7fa;
  margin:0;
}
header{
  background:linear-gradient(90deg,#0a3cff,#00c897);
  color:#fff;
  padding:25px;
  text-align:center;
  font-size:26px;
  font-weight:700;
}
.container{
  max-width:1200px;
  margin:30px auto;
  background:#fff;
  border-radius:16px;
  padding:25px;
  box-shadow:0 10px 30px rgba(0,0,0,.1);
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
}
.stat{
  background:#f9fbff;
  padding:20px;
  border-radius:14px;
  text-align:center;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}
.stat h3{margin:0;color:#555}
.stat p{font-size:28px;margin:10px 0;color:#0a3cff;font-weight:700}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid #ddd;
  padding:10px;
  text-align:center;
}
th{
  background:#0a3cff;
  color:white;
}
input,select{
  padding:6px;
  border-radius:6px;
  border:1px solid #ccc;
}
button.action{
  background:#ff4d4f;
  border:none;
  color:white;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
}
button.action:hover{background:#d9363e}

.calendar{
  margin-top:40px;
}
.calendar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}
.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}
.day{
  background:#f9fbff;
  border-radius:10px;
  padding:10px;
  min-height:80px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}
.day strong{color:#0a3cff}
.day span{
  display:block;
  margin-top:5px;
  font-size:12px;
}
.reviews{
  margin-top:40px;
}
.review{
  background:#f9fbff;
  padding:15px;
  border-radius:12px;
  margin:10px 0;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
</style>
</head>

<body>

<header>ASH Window Cleaning ‚Äì Administration</header>

<div class="container">

<!-- STATS -->
<div class="stats">
  <div class="stat">
    <h3>R√©servations</h3>
    <p id="stat-bookings">0</p>
  </div>
  <div class="stat">
    <h3>Travaux termin√©s</h3>
    <p id="stat-done">0</p>
  </div>
  <div class="stat">
    <h3>Revenus (DT)</h3>
    <p id="stat-revenue">0</p>
  </div>
  <div class="stat">
    <h3>Note moyenne</h3>
    <p id="avg-rating">‚≠ê 0</p>
  </div>
</div>

<!-- BOOKINGS TABLE -->
<h2>üìÖ R√©servations</h2>
<table>
<thead>
<tr>
<th>Date</th><th>Nom</th><th>T√©l√©phone</th><th>Service</th>
<th>Adresse</th><th>Montant</th><th>Statut</th><th>Action</th>
</tr>
</thead>
<tbody id="bookings"></tbody>
</table>

<!-- CALENDAR -->
<div class="calendar">
  <div class="calendar-header">
    <button onclick="changeMonth(-1)">‚óÄ</button>
    <h3 id="month-title"></h3>
    <button onclick="changeMonth(1)">‚ñ∂</button>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</div>

<!-- REVIEWS -->
<div class="reviews">
<h2>‚≠ê Avis clients</h2>
<div id="reviews"></div>
</div>

</div>

<script>
// Firebase
firebase.initializeApp({
 apiKey:"AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
 authDomain:"admin-ash-f622c.firebaseapp.com",
 projectId:"admin-ash-f622c"
});
const db=firebase.firestore();

let allBookings=[];
let currentMonth=new Date().getMonth();
let currentYear=new Date().getFullYear();

// BOOKINGS
db.collection("bookings").onSnapshot(snap=>{
  allBookings=[];
  let done=0,revenue=0;
  const tbody=document.getElementById("bookings");
  tbody.innerHTML="";

  snap.forEach(doc=>{
    const d=doc.data(); allBookings.push(d);
    if(d.done){done++; revenue+=Number(d.amount||0);}

    tbody.innerHTML+=`
<tr>
<td>${d.date||""}</td>
<td><input value="${d.name||""}" onchange="update('${doc.id}','name',this.value)"></td>
<td><input value="${d.phone||""}" onchange="update('${doc.id}','phone',this.value)"></td>
<td>${d.service||""}</td>
<td><input value="${d.address||""}" onchange="update('${doc.id}','address',this.value)"></td>
<td><input type="number" value="${d.amount||0}" onchange="update('${doc.id}','amount',this.value)"></td>
<td>
<select onchange="update('${doc.id}','done',this.value==='true')">
<option value="false">En attente</option>
<option value="true" ${d.done?"selected":""}>Termin√©</option>
</select>
</td>
<td><button class="action" onclick="del('${doc.id}','bookings')">Supprimer</button></td>
</tr>`;
  });

  document.getElementById("stat-bookings").textContent=snap.size;
  document.getElementById("stat-done").textContent=done;
  document.getElementById("stat-revenue").textContent=revenue;

  renderCalendar();
});

// CALENDAR
function renderCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const monthName=new Date(currentYear,currentMonth).toLocaleString("fr",{month:"long",year:"numeric"});
  document.getElementById("month-title").textContent=monthName;

  const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();

  for(let d=1; d<=daysInMonth; d++){
    const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const count=allBookings.filter(b=>b.date===dateStr).length;
    cal.innerHTML+=`
<div class="day">
<strong>${d}</strong>
<span>${count} r√©servation(s)</span>
</div>`;
  }
}
function changeMonth(v){
  currentMonth+=v;
  if(currentMonth<0){currentMonth=11;currentYear--}
  if(currentMonth>11){currentMonth=0;currentYear++}
  renderCalendar();
}

// REVIEWS
db.collection("ratings").onSnapshot(snap=>{
 let total=0;
 document.getElementById("reviews").innerHTML="";
 snap.forEach(doc=>{
  const d=doc.data(); total+=d.rating;
  document.getElementById("reviews").innerHTML+=`
<div class="review">‚≠ê ${d.rating} ‚Äì ${d.name}</div>`;
 });
 document.getElementById("avg-rating").textContent="‚≠ê "+(snap.size? (total/snap.size).toFixed(1):0);
});

// HELPERS
function update(id,f,v){db.collection("bookings").doc(id).update({[f]:v})}
function del(id,c){if(confirm("Supprimer ?")) db.collection(c).doc(id).delete()}
</script>

</body>
</html>
