<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - ASH</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<style>
body{font-family:Arial;background:#f5f7fa;padding:20px}
header{background:#1f2933;color:#fff;padding:15px;text-align:center;border-radius:10px}
h2{margin-top:30px;color:#0a5cff}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
th,td{border:1px solid #ddd;padding:10px;text-align:center}
th{background:#0a5cff;color:#fff}
tr:nth-child(even){background:#f9f9f9}
.logout{margin-top:15px;background:#1f2933;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer}
.delete-btn{background:#f44336;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer}
.rating-summary{margin:10px 0;font-size:18px;font-weight:bold}
</style>
</head>

<body>

<header>
  <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ASH</h1>
</header>

<button class="logout" id="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

<h2>ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
<table>
<thead>
<tr>
  <th>Ø§Ù„ÙŠÙˆÙ…</th>
  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th>Ø§Ù„ÙˆÙ‚Øª</th>
  <th>Ø§Ù„Ø§Ø³Ù…</th>
  <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
  <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
  <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
</tr>
</thead>
<tbody id="bookings"></tbody>
</table>

<h2>â­ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h2>
<div class="rating-summary" id="rating-average">Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: --</div>

<table>
<thead>
<tr>
  <th>Ø§Ù„Ø§Ø³Ù…</th>
  <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
  <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
  <th>Ø­Ø°Ù</th>
</tr>
</thead>
<tbody id="ratings"></tbody>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
  authDomain: "admin-ash-f622c.firebaseapp.com",
  projectId: "admin-ash-f622c",
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

// Ø­Ù…Ø§ÙŠØ©
auth.onAuthStateChanged(user=>{
  if(!user) location.href="login.html";
});

// ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
document.getElementById("logout").onclick=()=>{
  auth.signOut().then(()=>location.href="login.html");
};

// ===== Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª =====
db.collection("bookings").orderBy("date","desc").onSnapshot(snap=>{
  const tbody=document.getElementById("bookings");
  tbody.innerHTML="";
  snap.forEach(doc=>{
    const d=doc.data();
    const dayName = d.date
      ? new Date(d.date).toLocaleDateString("ar-TN",{weekday:"long"})
      : "-";

    tbody.innerHTML+=`
    <tr>
      <td>${dayName}</td>
      <td>${d.date || "-"}</td>
      <td>${d.time || "-"}</td>
      <td>${d.name}</td>
      <td>${d.phone}</td>
      <td>${d.service}</td>
      <td>${d.address}</td>
    </tr>`;
  });
});

// ===== Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª + Ø§Ù„Ù…Ø¹Ø¯Ù„ =====
db.collection("ratings").orderBy("timestamp","desc").onSnapshot(snap=>{
  const tbody=document.getElementById("ratings");
  const avgBox=document.getElementById("rating-average");
  tbody.innerHTML="";

  let total=0, count=0;

  snap.forEach(doc=>{
    const d=doc.data();
    total += d.rating;
    count++;

    const date = d.timestamp
      ? new Date(d.timestamp).toLocaleString("ar-TN")
      : "-";

    tbody.innerHTML+=`
    <tr>
      <td>${d.name}</td>
      <td>${d.email || "-"}</td>
      <td>${"â­".repeat(d.rating)}</td>
      <td>${date}</td>
      <td>
        <button class="delete-btn" onclick="deleteRating('${doc.id}')">âŒ</button>
      </td>
    </tr>`;
  });

  if(count>0){
    avgBox.textContent = `Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${(total/count).toFixed(1)} / 5 â­`;
  } else {
    avgBox.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯";
  }
});

// Ø­Ø°Ù ØªÙ‚ÙŠÙŠÙ…
function deleteRating(id){
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ")){
    db.collection("ratings").doc(id).delete();
  }
}
</script>

</body>
</html>
