<!doctype html>
<html lang="fr" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Administration - ASH Window Cleaning</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family:'Poppins',sans-serif; margin:0; padding:0; background:#f5f7fa; }
header { background: linear-gradient(90deg,#0a3cff,#00c897); color:#fff; text-align:center; padding:20px; font-size:22px; font-weight:700; }
.container { max-width:1200px; margin:20px auto; padding:15px; }

h2 { color:#0a3cff; margin-top:30px; text-align:center; }
table { width:100%; border-collapse:collapse; margin-top:15px; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.1);}
th,td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#0a3cff; color:#fff; }
input, select { width:90%; padding:6px; border-radius:6px; border:1px solid #ccc; }
button { background:#0a3cff; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
button:hover { background:#084dcc; }

.pagination { text-align:center; margin:15px 0; }
.pagination button { margin:0 5px; }
.stats { display:flex; justify-content:space-around; flex-wrap:wrap; margin-top:30px; }
.stat-box { background:#fff; padding:20px; border-radius:12px; width:200px; margin:10px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
.stat-box h3 { margin:10px 0; color:#0a3cff; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

</head>
<body>

<header>ASH Window Cleaning - Administration</header>

<div class="container">

<h2>üìÖ R√©servations</h2>
<table>
<thead>
<tr>
  <th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>Service</th>
  <th>Adresse</th><th>Date</th><th>Heure</th>
  <th>Montant (DT)</th><th>Termin√©</th><th>Actions</th>
</tr>
</thead>
<tbody id="bookings"></tbody>
</table>
<div class="pagination" id="bookings-pagination"></div>

<h2>‚≠ê Avis Clients</h2>
<table>
<thead>
<tr>
  <th>Nom</th><th>Email</th><th>Note</th><th>Message</th><th>Actions</th>
</tr>
</thead>
<tbody id="ratings"></tbody>
</table>
<div class="pagination" id="ratings-pagination"></div>

<h2>üìä Statistiques</h2>
<div class="stats">
  <div class="stat-box" id="total-bookings">
    <h3>Total R√©servations</h3><p>0</p>
  </div>
  <div class="stat-box" id="total-done">
    <h3>R√©servations Termin√©es</h3><p>0</p>
  </div>
  <div class="stat-box" id="average-rating">
    <h3>Note Moyenne</h3><p>0</p>
  </div>
</div>

</div>

<script>
// ===== Firebase Init =====
const firebaseConfig = {
  apiKey: "AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
  authDomain: "admin-ash-f622c.firebaseapp.com",
  projectId: "admin-ash-f622c",
  storageBucket: "admin-ash-f622c.appspot.com",
  messagingSenderId: "76505742154",
  appId: "1:76505742154:web:dc4f190f9f2de80acb1fb3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Notifications =====
if(Notification.permission !== "granted"){ Notification.requestPermission(); }
db.collection("bookings").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change=>{
    if(change.type==="added" && Notification.permission==="granted"){
      new Notification("Nouvelle r√©servation",{
        body:`Nom: ${change.doc.data().name}\nService: ${change.doc.data().service}`,
        icon:"icon-192.png"
      });
    }
  });
});
db.collection("ratings").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change=>{
    if(change.type==="added" && Notification.permission==="granted"){
      new Notification("Nouvel avis re√ßu",{
        body:`Nom: ${change.doc.data().name}\nNote: ${change.doc.data().rating} ‚≠ê\nMessage: ${change.doc.data().message||""}`,
        icon:"icon-192.png"
      });
    }
  });
});

// ===== Pagination Config =====
const pageSize = 5;
let bookingsData = [];
let bookingsPage = 1;
let ratingsData = [];
let ratingsPage = 1;

// ===== Load Bookings =====
function loadBookings(){
  db.collection("bookings").orderBy("date","desc").get().then(snapshot=>{
    bookingsData = snapshot.docs.map(d=>({id:d.id,...d.data()}));
    renderBookings();
    updateStats();
  });
}

function renderBookings(){
  const tbody = document.getElementById("bookings");
  tbody.innerHTML="";
  const start = (bookingsPage-1)*pageSize;
  const pageItems = bookingsData.slice(start,start+pageSize);
  let totalDone=0;
  pageItems.forEach(d=>{
    const doneChecked = d.done ? "checked" : "";
    if(d.done) totalDone++;
    tbody.innerHTML+=`
      <tr>
        <td><input value="${d.name}" onchange="updateBooking('${d.id}','name',this.value)"></td>
        <td><input value="${d.phone}" onchange="updateBooking('${d.id}','phone',this.value)"></td>
        <td>${d.email}</td>
        <td>${d.service}</td>
        <td>${d.address}</td>
        <td>${d.date}</td>
        <td>${d.time}</td>
        <td><input type="number" value="${d.amount||0}" onchange="updateBooking('${d.id}','amount',this.value)"></td>
        <td><input type="checkbox" ${doneChecked} onchange="updateBooking('${d.id}','done',this.checked)"></td>
        <td><button onclick="deleteBooking('${d.id}')">Supprimer</button></td>
      </tr>`;
  });
  document.getElementById("total-bookings").querySelector("p").textContent = bookingsData.length;
  document.getElementById("total-done").querySelector("p").textContent = bookingsData.filter(b=>b.done).length;
  renderPagination("bookings-pagination",bookingsData.length,bookingsPage,total=>{ bookingsPage=total; renderBookings(); });
}

// ===== Load Ratings =====
function loadRatings(){
  db.collection("ratings").orderBy("createdAt","desc").get().then(snapshot=>{
    ratingsData = snapshot.docs.map(d=>({id:d.id,...d.data()}));
    renderRatings();
  });
}

function renderRatings(){
  const tbody = document.getElementById("ratings");
  tbody.innerHTML="";
  const start = (ratingsPage-1)*pageSize;
  const pageItems = ratingsData.slice(start,start+pageSize);
  let totalRating=0;
  pageItems.forEach(d=>{
    totalRating+=d.rating||0;
    tbody.innerHTML+=`
      <tr>
        <td>${d.name}</td>
        <td>${d.email}</td>
        <td>${"‚≠ê".repeat(d.rating)}</td>
        <td>${d.message||""}</td>
        <td><button onclick="deleteRating('${d.id}')">Supprimer</button></td>
      </tr>`;
  });
  document.getElementById("average-rating").querySelector("p").textContent = ratingsData.length ? (ratingsData.reduce((a,b)=>a+(b.rating||0),0)/ratingsData.length).toFixed(1) : 0;
  renderPagination("ratings-pagination",ratingsData.length,ratingsPage,total=>{ ratingsPage=total; renderRatings(); });
}

// ===== Pagination Buttons =====
function renderPagination(containerId,totalItems,currentPage,callback){
  const container = document.getElementById(containerId);
  container.innerHTML="";
  const totalPages = Math.ceil(totalItems/pageSize);
  if(totalPages<=1) return;
  if(currentPage>1) container.innerHTML+=`<button onclick="${callback.name}(${currentPage-1})">Pr√©c√©dent</button>`;
  if(currentPage<totalPages) container.innerHTML+=`<button onclick="${callback.name}(${currentPage+1})">Suivant</button>`;
}

// ===== Update/Delete Functions =====
function updateBooking(id,field,value){
  if(field==="done") value=Boolean(value);
  if(field==="amount") value=Number(value);
  db.collection("bookings").doc(id).update({ [field]: value });
}
function deleteBooking(id){
  if(confirm("Voulez-vous vraiment supprimer cette r√©servation ?")){
    db.collection("bookings").doc(id).delete();
    bookingsData = bookingsData.filter(b=>b.id!==id);
    renderBookings();
  }
}
function deleteRating(id){
  if(confirm("Voulez-vous vraiment supprimer cet avis ?")){
    db.collection("ratings").doc(id).delete();
    ratingsData = ratingsData.filter(r=>r.id!==id);
    renderRatings();
  }
}

// ===== Stats =====
function updateStats(){
  document.getElementById("total-bookings").querySelector("p").textContent = bookingsData.length;
  document.getElementById("total-done").querySelector("p").textContent = bookingsData.filter(b=>b.done).length;
  document.getElementById("average-rating").querySelector("p").textContent = ratingsData.length ? (ratingsData.reduce((a,b)=>a+(b.rating||0),0)/ratingsData.length).toFixed(1) : 0;
}

// ===== Init =====
loadBookings();
loadRatings();
</script>

</body>
</html>
