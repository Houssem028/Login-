<!doctype html>
<html lang="fr" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin - ASH Window Cleaning</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- Leaflet pour cartes -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { font-family:'Poppins',sans-serif; background:#eef3ff; margin:0; padding:20px; }
h2 { text-align:center; color:#0a3cff; margin-top:20px; }
.container { max-width:1200px; margin:auto; }
table { width:100%; border-collapse:collapse; margin-top:20px; background:white; border-radius:12px; overflow:hidden; }
th,td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#0a3cff; color:white; }
button { padding:6px 10px; border:none; background:#0a3cff; color:white; border-radius:6px; cursor:pointer; }
button:hover { background:#084dcc; }
#admin-map { height:400px; margin-top:20px; border-radius:12px; }
#calendar { max-width:100%; margin-top:20px; background:white; border-radius:12px; padding:10px; }
</style>
</head>
<body>

<div class="container">

<h2>üìÖ R√©servations</h2>
<table>
<thead>
<tr>
<th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>Service</th><th>Adresse</th><th>Date</th><th>Heure</th><th>Montant</th><th>Fait</th><th>Actions</th>
</tr>
</thead>
<tbody id="bookings"></tbody>
</table>

<div class="total-box">
üí∞ Total des services effectu√©s : <span id="total-amount">0 DT</span>
</div>

<h2>‚≠ê Avis des clients</h2>
<table>
<thead>
<tr><th>Nom</th><th>Email</th><th>√âvaluation</th><th>Date</th><th>Actions</th></tr>
</thead>
<tbody id="ratings"></tbody>
</table>

<h2>üåç Carte des r√©servations</h2>
<div id="admin-map"></div>

<h2>üóìÔ∏è Calendrier des r√©servations</h2>
<div id="calendar"></div>

</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
  authDomain: "admin-ash-f622c.firebaseapp.com",
  projectId: "admin-ash-f622c",
  storageBucket: "admin-ash-f622c.appspot.com",
  messagingSenderId: "76505742154",
  appId: "1:76505742154:web:dc4f190f9f2de80acb1fb3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ====== R√©servations ======
const tbodyBookings = document.getElementById("bookings");
const totalAmountEl = document.getElementById("total-amount");
db.collection("bookings").orderBy("date","desc").onSnapshot(snapshot=>{
  tbodyBookings.innerHTML="";
  let total = 0;
  snapshot.forEach(doc=>{
    const d = doc.data();
    const checked = d.done ? "checked" : "";
    const amount = d.amount || "";
    if(d.done && d.amount) total += Number(d.amount);

    tbodyBookings.innerHTML += `<tr>
      <td>${d.name}</td>
      <td>${d.phone}</td>
      <td>${d.email || "-"}</td>
      <td>${d.service}</td>
      <td>${d.address}</td>
      <td>${d.date}</td>
      <td>${d.time}</td>
      <td><input type="number" min="0" value="${amount}" onchange="updateAmount('${doc.id}',this.value)"></td>
      <td><input type="checkbox" ${checked} onchange="toggleDone('${doc.id}',this.checked)"></td>
      <td><button onclick="deleteBooking('${doc.id}')">Supprimer</button></td>
    </tr>`;
  });
  totalAmountEl.textContent = total + " DT";
});

// Toggle fait
function toggleDone(id,val){ db.collection("bookings").doc(id).update({done:val}); }
// Update montant
function updateAmount(id,val){ db.collection("bookings").doc(id).update({amount:Number(val)}); }
// Delete
function deleteBooking(id){ db.collection("bookings").doc(id).delete(); }

// ====== Avis ======
const tbodyRatings = document.getElementById("ratings");
db.collection("ratings").orderBy("timestamp","desc").onSnapshot(snapshot=>{
  tbodyRatings.innerHTML="";
  snapshot.forEach(doc=>{
    const d = doc.data();
    tbodyRatings.innerHTML+=`<tr>
      <td>${d.name}</td>
      <td>${d.email || "-"}</td>
      <td>${"‚≠ê".repeat(d.rating)}</td>
      <td>${new Date(d.timestamp).toLocaleString("fr-FR")}</td>
      <td><button onclick="deleteRating('${doc.id}')">Supprimer</button></td>
    </tr>`;
  });
});
function deleteRating(id){ db.collection("ratings").doc(id).delete(); }

// ====== Carte ======
const adminMap = L.map('admin-map').setView([36.8,10.18],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(adminMap);
db.collection("bookings").onSnapshot(snapshot=>{
  adminMap.eachLayer(layer=>{ if(layer instanceof L.Marker) adminMap.removeLayer(layer); });
  snapshot.forEach(doc=>{
    const d = doc.data();
    if(d.lat && d.lng){
      L.marker([d.lat,d.lng]).addTo(adminMap)
        .bindPopup(`<b>${d.name}</b><br>${d.address}<br>${d.service}<br>${d.date} ${d.time}`);
    }
  });
});

// ====== Calendrier simple ======
const calendarEl = document.getElementById("calendar");
function renderCalendar(monthOffset=0){
  calendarEl.innerHTML="";
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth()+monthOffset;
  const firstDay = new Date(year,month,1).getDay();
  const lastDate = new Date(year,month+1,0).getDate();

  const table = document.createElement("table");
  table.style.width="100%";
  table.style.borderCollapse="collapse";
  const header = table.insertRow();
  ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"].forEach(d=>{ const th= document.createElement("th"); th.textContent=d; th.style.border="1px solid #ddd"; th.style.padding="6px"; th.style.background="#0a3cff"; th.style.color="#fff"; header.appendChild(th); });

  let row = table.insertRow();
  for(let i=0;i<firstDay;i++) row.insertCell();
  for(let d=1;d<=lastDate;d++){
    if(row.cells.length===7) row=table.insertRow();
    const cell = row.insertCell();
    cell.textContent=d;
    cell.style.border="1px solid #ddd"; cell.style.padding="6px"; cell.style.textAlign="center";

    // Colorer les jours avec r√©servation
    snapshot.forEach(doc=>{
      const date = new Date(doc.data().date);
      if(date.getDate()===d && date.getMonth()===month){
        cell.style.background="#00c897"; cell.style.color="white";
      }
    });
  }
  calendarEl.appendChild(table);
}
renderCalendar();
</script>

</body>
</html>
