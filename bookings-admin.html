<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Dashboard - ASH</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest-admin.json">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{font-family:'Poppins',sans-serif;margin:0;background:#f5f7fa;color:#333;}
header{background:linear-gradient(90deg,#0a3cff,#00c897);color:#fff;text-align:center;padding:20px;font-size:22px;font-weight:700;}
.container{max-width:1200px;margin:20px auto;padding:15px;}
h2{color:#0a3cff;margin-top:30px;text-align:center;}

table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,.1);}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:#0a3cff;color:#fff;}
input{width:90%;padding:6px;border-radius:6px;border:1px solid #ccc;}
button{background:#0a3cff;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}
button:hover{background:#084dcc;}

#map{height:400px;width:100%;margin-top:20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);}

.stats{display:flex;justify-content:space-around;flex-wrap:wrap;margin-top:30px;}
.stat-box{background:#fff;padding:20px;border-radius:12px;width:200px;margin:10px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.1);}
.stat-box h3{margin:10px 0;color:#0a3cff;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<header>ASH Admin Dashboard</header>

<div class="container">

<h2>üìÖ R√©servations</h2>
<table>
<thead>
<tr>
<th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>Service</th>
<th>Adresse</th><th>Date</th><th>Heure</th>
<th>Montant</th><th>Termin√©</th><th>Actions</th>
</tr>
</thead>
<tbody id="bookings"></tbody>
</table>

<h2>‚≠ê Avis Clients</h2>
<table>
<thead>
<tr><th>Nom</th><th>Email</th><th>Note</th><th>Message</th><th>Actions</th></tr>
</thead>
<tbody id="ratings"></tbody>
</table>

<h2>üìç Carte des r√©servations</h2>
<div id="map"></div>

<h2>üìä Statistiques</h2>
<div class="stats">
<div class="stat-box" id="total-bookings"><h3>Total R√©servations</h3><p>0</p></div>
<div class="stat-box" id="total-done"><h3>Termin√©es</h3><p>0</p></div>
<div class="stat-box" id="average-rating"><h3>Note Moyenne</h3><p>0</p></div>
</div>

</div>

<script>
// ===== Firebase =====
firebase.initializeApp({
  apiKey: "AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
  authDomain: "admin-ash-f622c.firebaseapp.com",
  projectId: "admin-ash-f622c"
});
const db = firebase.firestore();

// ===== Notifications =====
if(Notification.permission!=="granted"){
  Notification.requestPermission();
}

// ===== Map =====
const map = L.map('map').setView([36.8,10.2],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'¬© OpenStreetMap'
}).addTo(map);
let markers=[];

function updateMap(docs){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  docs.forEach(doc=>{
    const d=doc.data();
    if(d.lat && d.lng){
      const m=L.marker([d.lat,d.lng]).addTo(map)
      .bindPopup(`<b>${d.name}</b><br>${d.service}<br>${d.date} ${d.time}`);
      markers.push(m);
    }
  });
}

// ===== Bookings =====
db.collection("bookings").orderBy("date","desc").onSnapshot(snapshot=>{
  const tbody=document.getElementById("bookings");
  tbody.innerHTML="";
  let done=0;

  snapshot.forEach(doc=>{
    const d=doc.data();
    if(d.done) done++;

    tbody.innerHTML+=`
<tr>
<td><input value="${d.name}" onchange="updateBooking('${doc.id}','name',this.value)"></td>
<td><input value="${d.phone}" onchange="updateBooking('${doc.id}','phone',this.value)"></td>
<td>${d.email}</td>
<td>${d.service}</td>
<td>${d.address}</td>
<td>${d.date}</td>
<td>${d.time}</td>
<td><input type="number" value="${d.amount||0}" onchange="updateBooking('${doc.id}','amount',this.value)"></td>
<td><input type="checkbox" ${d.done?'checked':''} onchange="updateBooking('${doc.id}','done',this.checked)"></td>
<td><button onclick="deleteBooking('${doc.id}')">Supprimer</button></td>
</tr>`;
  });

  snapshot.docChanges().forEach(c=>{
    if(c.type==="added" && Notification.permission==="granted"){
      const d=c.doc.data();
      new Notification("Nouvelle r√©servation",{
        body:`${d.name} - ${d.service}`,
        icon:"icon-192.png"
      });
    }
  });

  document.querySelector("#total-bookings p").textContent=snapshot.size;
  document.querySelector("#total-done p").textContent=done;
  updateMap(snapshot.docs);
});

function updateBooking(id,f,v){
  if(f==="done") v=Boolean(v);
  if(f==="amount") v=Number(v);
  db.collection("bookings").doc(id).update({[f]:v});
}
function deleteBooking(id){
  if(confirm("Supprimer ?")) db.collection("bookings").doc(id).delete();
}

// ===== Ratings =====
db.collection("ratings").orderBy("createdAt","desc").onSnapshot(snapshot=>{
  const tbody=document.getElementById("ratings");
  tbody.innerHTML="";
  let total=0;

  snapshot.forEach(doc=>{
    const d=doc.data();
    total+=d.rating||0;
    tbody.innerHTML+=`
<tr>
<td>${d.name}</td>
<td>${d.email}</td>
<td>${"‚≠ê".repeat(d.rating)}</td>
<td>${d.message||""}</td>
<td><button onclick="deleteRating('${doc.id}')">Supprimer</button></td>
</tr>`;
  });

  snapshot.docChanges().forEach(c=>{
    if(c.type==="added" && Notification.permission==="granted"){
      const d=c.doc.data();
      new Notification("Nouvel avis",{
        body:`${d.name} - ${d.rating}‚≠ê`,
        icon:"icon-192.png"
      });
    }
  });

  document.querySelector("#average-rating p").textContent =
    snapshot.size ? (total/snapshot.size).toFixed(1) : 0;
});

function deleteRating(id){
  if(confirm("Supprimer ?")) db.collection("ratings").doc(id).delete();
}
</script>

</body>
</html>
