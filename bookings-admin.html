<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ASH Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest-admin.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#f5f7fa;}
header{background:linear-gradient(90deg,#0a3cff,#00c897);color:#fff;padding:15px;text-align:center;font-size:22px;font-weight:700;}

nav{display:flex;justify-content:center;gap:10px;background:#fff;padding:10px;box-shadow:0 4px 15px rgba(0,0,0,.1);}
nav button{border:none;background:#0a3cff;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;}
nav button.active{background:#00c897;}

.container{max-width:1200px;margin:20px auto;padding:10px;}
.section{display:none;}
.section.active{display:block;}

table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#0a3cff;color:#fff;}

button.action{background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}

#map{height:400px;border-radius:12px;}

.stats{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;}
.stat-box{background:#fff;width:220px;padding:20px;border-radius:12px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,.1);}
.stat-box h3{color:#0a3cff;margin-bottom:10px;}
.stat-box p{font-size:24px;font-weight:700;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-messaging-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<header>ASH Admin Dashboard</header>

<nav>
<button class="active" onclick="showSection('bookings',this)">üìÖ R√©servations</button>
<button onclick="showSection('ratings',this)">‚≠ê Avis</button>
<button onclick="showSection('mapSection',this)">üìç Carte</button>
<button onclick="showSection('stats',this)">üìä Statistiques</button>
</nav>

<div class="container">

<div id="bookings" class="section active">
<table>
<thead>
<tr>
<th>Nom</th><th>T√©l√©phone</th><th>Email</th><th>Service</th>
<th>Date</th><th>Heure</th><th>Montant</th><th>‚úî</th><th></th>
</tr>
</thead>
<tbody id="bookingsBody"></tbody>
</table>
</div>

<div id="ratings" class="section">
<table>
<thead>
<tr><th>Nom</th><th>Email</th><th>Note</th><th>Message</th><th></th></tr>
</thead>
<tbody id="ratingsBody"></tbody>
</table>
</div>

<div id="mapSection" class="section">
<div id="map"></div>
</div>

<div id="stats" class="section">
<div class="stats">
<div class="stat-box"><h3>Total R√©servations</h3><p id="statBookings">0</p></div>
<div class="stat-box"><h3>Termin√©es</h3><p id="statDone">0</p></div>
<div class="stat-box"><h3>Note Moyenne</h3><p id="statRating">0</p></div>
</div>
</div>

</div>

<script>
// ===== Firebase Init =====
firebase.initializeApp({
  apiKey:"AIzaSyAJxzFknapSh0fnPfIXwEEK3OijSKlqxco",
  authDomain:"admin-ash-f622c.firebaseapp.com",
  projectId:"admin-ash-f622c",
  messagingSenderId:"76505742154",
  appId:"1:76505742154:web:dc4f190f9f2de80acb1fb3"
});
const db = firebase.firestore();

// ===== Navigation =====
function showSection(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}

// ===== Map =====
const map = L.map('map').setView([36.8,10.2],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers=[];

// ===== BOOKINGS + STATS =====
db.collection("bookings").onSnapshot(snapshot=>{
  const body=document.getElementById("bookingsBody");
  body.innerHTML="";
  let done=0;

  document.getElementById("statBookings").textContent=snapshot.size;

  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  snapshot.forEach(doc=>{
    const d=doc.data();
    if(d.done) done++;

    body.innerHTML+=`
<tr>
<td>${d.name}</td>
<td>${d.phone}</td>
<td>${d.email}</td>
<td>${d.service}</td>
<td>${d.date}</td>
<td>${d.time}</td>
<td>${d.amount||0}</td>
<td>${d.done?'‚úî':'‚ùå'}</td>
<td><button class="action" onclick="db.collection('bookings').doc('${doc.id}').delete()">X</button></td>
</tr>`;

    if(d.lat && d.lng){
      markers.push(L.marker([d.lat,d.lng]).addTo(map));
    }
  });

  document.getElementById("statDone").textContent=done;
});

// ===== RATINGS =====
db.collection("ratings").onSnapshot(snapshot=>{
  const body=document.getElementById("ratingsBody");
  body.innerHTML="";
  let total=0;

  snapshot.forEach(doc=>{
    const d=doc.data();
    total+=d.rating||0;
    body.innerHTML+=`
<tr>
<td>${d.name}</td>
<td>${d.email}</td>
<td>${"‚≠ê".repeat(d.rating)}</td>
<td>${d.message||""}</td>
<td><button class="action" onclick="db.collection('ratings').doc('${doc.id}').delete()">X</button></td>
</tr>`;
  });

  document.getElementById("statRating").textContent =
    snapshot.size?(total/snapshot.size).toFixed(1):0;
});

// ===== PUSH NOTIFICATIONS =====
const messaging=firebase.messaging();

navigator.serviceWorker.register("firebase-messaging-sw.js")
.then(reg=>{
  messaging.useServiceWorker(reg);
  Notification.requestPermission().then(p=>{
    if(p==="granted"){
      messaging.getToken().then(token=>{
        if(token){
          db.collection("adminTokens").doc(token).set({token});
        }
      });
    }
  });
});

messaging.onMessage(payload=>{
  new Notification(payload.notification.title,{
    body:payload.notification.body,
    icon:"icon-192.png"
  });
});
</script>

</body>
</html>
